<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Universal AI Chat</title>
  
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'gemini-bg': '#f8fafc',
            'gemini-dark-bg': '#0f172a',
          }
        }
      }
    }
  </script>

  <!-- Marked.js for markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
      --vh: 1vh;
    }
    @media (max-width: 640px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .sidebar.open {
        transform: translateX(0);
      }
    }
    .message-content pre {
      @apply bg-gray-100 dark:bg-gray-800 p-3 rounded-lg overflow-x-auto text-sm;
    }
    .message-content code {
      @apply bg-gray-200 dark:bg-gray-700 px-1 rounded;
    }
    .message-content pre code {
      @apply bg-transparent;
    }
    #input-area {
      min-height: 56px;
    }
    body {
      overscroll-behavior: none;
    }
  </style>
</head>
<body class="bg-gemini-bg dark:bg-gemini-dark-bg text-gray-900 dark:text-gray-100 min-h-screen flex flex-col antialiased">

  <!-- Loading overlay -->
  <div id="loading" class="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="text-xl font-medium">Loading Universal AI Chat...</div>
  </div>

  <div class="flex flex-1 overflow-hidden relative">

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 z-40 w-72 bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 flex flex-col transform md:relative md:translate-x-0">
      
      <div class="p-4 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between">
        <h1 class="text-xl font-semibold">AI Chat</h1>
        <button id="new-chat-btn" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
      </div>

      <div class="flex-1 overflow-y-auto p-3 space-y-2" id="chat-list"></div>

      <div class="p-4 border-t border-gray-200 dark:border-gray-800 space-y-3">
        <button id="toggle-dark" class="w-full flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
          <span>Dark Mode</span>
          <span id="dark-mode-label">Off</span>
        </button>
        <button id="settings-btn" class="w-full text-left p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
          Settings
        </button>
      </div>
    </aside>

    <!-- Main content -->
    <main class="flex-1 flex flex-col min-h-screen md:min-h-0">

      <!-- Top bar (mobile only) -->
      <header class="md:hidden bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 px-4 py-3 flex items-center justify-between sticky top-0 z-30">
        <button id="menu-btn" class="p-2 -ml-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
        <h2 id="current-chat-title" class="font-medium truncate max-w-[60vw]">New Chat</h2>
        <div class="w-10"></div>
      </header>

      <!-- Messages container -->
      <div id="messages" class="flex-1 overflow-y-auto px-4 py-6 space-y-6 pb-32 md:pb-24">
        <!-- Welcome message -->
        <div class="text-center text-gray-500 dark:text-gray-400 py-12">
          <h3 class="text-2xl font-semibold mb-3">Welcome to Universal AI Chat</h3>
          <p>Ask anything — powered by OpenRouter</p>
        </div>
      </div>

      <!-- Input area -->
      <div id="input-area" class="fixed bottom-0 left-0 right-0 md:left-72 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 p-4 z-20 transition-all">
        <form id="chat-form" class="max-w-4xl mx-auto flex gap-3">
          <textarea
            id="user-input"
            rows="1"
            placeholder="Type your message..."
            class="flex-1 resize-none rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 px-5 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 max-h-40 min-h-[56px] shadow-sm"
          ></textarea>
          <button
            type="submit"
            id="send-btn"
            class="p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
          </button>
        </form>
      </div>
    </main>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-lg w-full mx-4 p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Settings</h2>
        <button id="close-settings" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="space-y-6">
        <div>
          <label class="block text-sm font-medium mb-1">OpenRouter API Key</label>
          <input id="api-key" type="password" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="sk-or-..." />
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Model</label>
          <input id="model" type="text" value="deepseek/deepseek-r1:free" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent focus:outline-none focus:ring-2 focus:ring-blue-500" />
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Example: openai/gpt-4o-mini, anthropic/claude-3.5-sonnet, etc.</p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Global System Prompt (optional)</label>
          <textarea id="system-prompt" rows="4" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-transparent focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"></textarea>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Applied to every new chat unless overridden</p>
        </div>
      </div>

      <div class="mt-8 flex justify-end gap-3">
        <button id="cancel-settings" class="px-5 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
        <button id="save-settings" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
      </div>
    </div>
  </div>

  <!-- Backdrop for mobile sidebar -->
  <div id="backdrop" class="fixed inset-0 bg-black/40 z-30 hidden md:hidden"></div>

  <script>
    // ────────────────────────────────────────────────
    //  State & Constants
    // ────────────────────────────────────────────────

    const STORAGE_KEY = 'universal-ai-chat-v1';
    let chats = [];
    let currentChatId = null;
    let abortController = null;
    let isDarkMode = localStorage.getItem('darkMode') === 'true';
    let apiKey = '';
    let selectedModel = 'deepseek/deepseek-r1:free';
    let globalSystemPrompt = '';

    const elements = {
      messages: document.getElementById('messages'),
      chatList: document.getElementById('chat-list'),
      userInput: document.getElementById('user-input'),
      sendBtn: document.getElementById('send-btn'),
      form: document.getElementById('chat-form'),
      loading: document.getElementById('loading'),
      sidebar: document.getElementById('sidebar'),
      menuBtn: document.getElementById('menu-btn'),
      backdrop: document.getElementById('backdrop'),
      currentTitle: document.getElementById('current-chat-title'),
      newChatBtn: document.getElementById('new-chat-btn'),
      toggleDark: document.getElementById('toggle-dark'),
      darkModeLabel: document.getElementById('dark-mode-label'),
      settingsBtn: document.getElementById('settings-btn'),
      settingsModal: document.getElementById('settings-modal'),
      apiKeyInput: document.getElementById('api-key'),
      modelInput: document.getElement
